'use strict';var _createClass=function(){function a(b,c){for(var f,d=0;d<c.length;d++)f=c[d],f.enumerable=f.enumerable||!1,f.configurable=!0,'value'in f&&(f.writable=!0),Object.defineProperty(b,f.key,f)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}(function(){function a(){return b(Math.round(99999999*Math.random()),10,62)}function b(d,f,h,j,k){var q,l='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',p=[],r='-'==(d+='').trim()[0],s=0;j||(j=l),k||(k=l),r&&(d=d.slice(1));for(var u=d.length;u--;)s+=j.indexOf(d[u])*Math.pow(f,d.length-u-1);for(;0!=s;p.unshift(k[q]))q=s%h,s=Math.floor(s/h);return s&&p.unshift(k[s]),(r?'-':'')+p.join('')}var c=function(){function d(f){var j=this;if(_classCallCheck(this,d),this.addr=f,this.groups=new Set,this.on=!1,this.waiting=!1,this.onOnlineChange=null,this.onData=null,this.onConnected=null,this.pinger=setInterval(function(){j.opened&&j.ws.send('')},25000),this.user=b(Date.now(),10,62)+'-'+a(),this.ws=null,this.subscribing=!1,window.localStorage){var h=localStorage.getItem('online_user');h?this.user=h:localStorage.setItem('online_user',this.user)}f&&(this.on=!0,this.connet())}return _createClass(d,[{key:'send',value:function send(f){this.ws.send(JSON.stringify(f))}},{key:'enter',value:function enter(f){if('string'!=typeof f)throw'name is not a string:'+f;return this.groups.add(f),this.connected&&this.send({_:'enter',g:f,u:this.user}),this}},{key:'leave',value:function leave(f){if('string'!=typeof f)throw'name is not a string:'+f;return this.connected&&this.groups.delete(f)&&this.send({_:'leave',g:f}),this}},{key:'subscribe',value:function subscribe(){this.subscribing=!0,this.connected&&this.send({_:'sub',opt:'sub',u:this.user})}},{key:'unsubscribe',value:function unsubscribe(){this.subscribing=!1,this.connected&&this.send({_:'sub',opt:'unsub'})}},{key:'requestList',value:function requestList(){this.send({_:'sub',opt:'list'})}},{key:'leaveAll',value:function leaveAll(){if(this.connected){var k=!0,l=!1,p=void 0;try{for(var h,q,f=this.groups[Symbol.iterator]();!(k=(h=f.next()).done);k=!0)q=h.value,this.leave(q)}catch(q){l=!0,p=q}finally{try{!k&&f.return&&f.return()}finally{if(l)throw p}}}return this}},{key:'_reportOl',value:function _reportOl(f){this.onOnlineChange&&this.onOnlineChange(f)}},{key:'connet',value:function connet(f){var j=this;if((this.waiting=!1,f&&(this.addr=f),!1!==this.on)&&!this.opened){var h=this.ws=new WebSocket(this.addr);return h.onmessage=function(k){if('connected'===k.data){h.connected=!0;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var p,q,l=j.groups[Symbol.iterator]();!(_iteratorNormalCompletion2=(p=l.next()).done);_iteratorNormalCompletion2=!0)q=p.value,j.enter(q)}catch(s){_didIteratorError2=!0,_iteratorError2=s}finally{try{!_iteratorNormalCompletion2&&l.return&&l.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return j.subscribing&&j.subscribe(),void(j.onConnected&&j.onConnected())}var r=JSON.parse(k.data);switch(r._){case'ol':case'subol':{r.c=parseInt(r.c,32),r.u=parseInt(r.u,32),j._reportOl(r);break}default:{j.onData&&j.onData(r);break}}},h.onclose=function(){if(!j.waiting){if(j.connected){var r=!0,s=!1,u=void 0;try{for(var p,v,l=j.groups[Symbol.iterator]();!(r=(p=l.next()).done);r=!0)v=p.value,j._reportOl({g:v,c:0,u:0})}catch(v){s=!0,u=v}finally{try{!r&&l.return&&l.return()}finally{if(s)throw u}}}j.ws.connected=!1,j.waiting=!0,setTimeout(function(){j.connet()},5e3)}},h.onerror=function(){return h.onclose()},this}}},{key:'close',value:function close(){this.on=!1,this.ws.close(),clearInterval(this.pinger)}},{key:'opened',get:function get(){return this.ws&&1===this.ws.readyState}},{key:'connected',get:function get(){return this.ws.connected}}]),d}();window.Online=c})();